{% extends 'game_base.html' %}
{% load static %}

{% block title %}
    Game Room Detail
{% endblock %}

{% block style %}
    <style type="text/css">
        canvas {
                display: block;
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
        #VideoGrid{
            border: red dotted 2px;
            width: 40%;
            {#display: grid;#}
            grid-template-columns: repeat(auto-fill, 300px);
            grid-auto-rows: 300px;
        }
        video{
            {#display: inline-block;#}
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
{% endblock %}

{% block content %}
    {% if game_room %}
            <div>
                Game Room ID: {{ game_room.unique_game_id }}
                <br/>
                Game Room Admin: {{ game_room.admin.username }}
                <br/>
                <br/>
{#                {% if user.is_authenticated and user.username == game_room.admin.username %}#}
{#                    <button id="id_start_game_{{ game_room.pk }}">#}
{#                        Start Game#}
{#                    </button>#}
{#                    <br/>#}
{#                    <button id="id_end_game_{{ game_room.pk }}" disabled>#}
{#                        End Game#}
{#                    </button>#}
{#                {% endif %}#}
{#                <br/>#}
{#                <br/>#}
            </div>
            <div>
                <div style="display: inline-block; border-style: dotted; margin-right: 50px;">
                    <p>Connected Players</p>
                    <ul id="id_connected_players_{{ game_room.pk }}">
    {#                    {% for player in players %}#}
    {#                        {% if player.is_online %}#}
    {#                            <li id="id_connected_players_{{ player.player.pk }}_{{ game_room.pk }}">{{ player.player.username }}</li>#}
    {#                        {% endif %}#}
    {#                    {% endfor %}#}
                    </ul>
                </div>
                <div style="display: inline-block; border-style: dotted;">
                    <p>Game Room Notifications</p>
                    <ul id="id_game_room_notifications_{{ game_room.pk }}">

                    </ul>
                </div>
                <br/>
                <div style="display: inline-block; margin-right: 50px; border-style: dotted;">
                    <p>Current Top Card</p>
                    <p id="id_top_card_{{ game_room.unique_game_id }}"></p>
                </div>
                <div style="display: inline-block; border-style: dotted; margin-top: 35px;">
                    <p>My Hand</p>
                    <ul id="id_hand_{{ user.username }}_{{ game_room.unique_game_id }}">
                    </ul>
                </div>
            </div>

            <div id="VideoGrid">
    {#            <video >#}
    {#                <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">#}
    {#                Your browser does not support HTML video.#}
    {#            </video>#}
            </div>


        {% endif %}
{% endblock %}

{% block javascript %}
    <script src=" {% static 'js/jquery.min.js' %} "></script>
    <script type="text/javascript" src="{% static 'js/phaserjs/game.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/phaserjs/Scene1.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/phaserjs/Scene2.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/phaserjs/Scene3.js' %}"></script>

    <script>
        // This script tag contains only DOM elements picked using jQuery.
        let connectedList = $("#id_connected_players_{{ game_room.pk }}");
        let connectedListChildren = connectedList.children();
        let startGameButton = $('#id_start_game_{{ game_room.pk }}');
        let endGameButton = $('#id_end_game_{{ game_room.pk }}');
        let notificationList = $('#id_game_room_notifications_{{ game_room.pk }}');
        let myHandList = $("#id_hand_{{ user.username }}_{{ game_room.unique_game_id }}");
        let topCardElem = $("#id_top_card_{{ game_room.unique_game_id }}");
    </script>

    <script>

        /*
            This script tag contains only classes defined in this file.
            Following classes have been defined so far:
            1. Card
            2. Hand
            3. Game
        */

        class Card {
            constructor(category, number) {
                this.category = category;
                this.number = number;
            }
        }

        class Hand {
            constructor() {
                this.cards = [];
                this.cardSprites = []; // Sprites corresponding to cards
            }

            emptyHand() {
                this.cardSprites = [];
                this.cards = [];
            }

            getCount() {
                // Method that returns count of cards in this hand.
                return this.cards.length;
            }

            getActiveCount() {
                // Returns count of active card i.e. not null cards only.
                let count = 0;
                for(let card of this.cards) {
                    if(card != null) {
                        count++;
                    }
                }
                return count;
            }

            getCardAt(i) {
                // Method to return card at ith index in this hand.
                if(i < this.getCount()) {
                    return this.cards[i];
                }
            }

            getCardSpriteAt(i) {
                if(i < this.getCount()) {
                    return this.cardSprites[i];
                }
            }

            removeCardAndCardSpriteAt(i) {
                {#this.cards.splice(i, 1);#}
                {#this.cardSprites.splice(i, 1);#}
                this.cards[i] = null;
                this.cardSprites[i] = null;
            }

            addCardAndCardSprite(card, cardSprite) {
                this.cards.push(card);
                this.cardSprites.push(cardSprite);
            }

            getDepth(cardSprite) {
                // Getting depth of the card.
                let depth = 1;
                for(let i = 0; i < this.getCount(); ++i) {
                    let thisCardSprite = this.getCardSpriteAt(i);
                    if(thisCardSprite != null) {
                        if(JSON.stringify(cardSprite) === JSON.stringify(thisCardSprite)) {
                            return depth;
                        }
                        depth += 1;
                    }
                }
            }
        }

        class Game {
            constructor(gameData) {
                {#console.log(gameData);#}
                this.uniqueId = gameData.uniqueId;
                this.players = gameData.players;
                this.topCard = gameData.topCard;
                this.topColor = gameData.topColor;
                this.direction = gameData.direction;
                this.currentPlayerIndex = gameData.currentPlayerIndex;
                this.isGameRunning = false;
                this.canDrawCard = false;
                this.coordinatesOfPlayers = {};
                // Adding Players to DOM.
                // Game.addPlayersToDOM(this.players);
            }

            copyData(gameData) {
                {#console.log(gameData);#}
                if(gameData.topCard) {
                    this.topCard = new Card(gameData.topCard.category, gameData.topCard.number);
                    this.topColor = gameData.topColor;
                }
                this.direction = gameData.direction;
                this.currentPlayerIndex = gameData.currentPlayerIndex;
            }

            getTopCard() {
                return this.topCard;
            }

            getPlayersCount() {
                return this.players.length;
            }

            getPlayers() {
                return this.players;
            }

            getCurrentPlayer() {
                if(this.currentPlayerIndex >= 0) {
                    return this.players[this.currentPlayerIndex];
                }
                else {
                    return null;
                }
            }

            setTopCard(card) {
                this.topCard = card;
            }

            connectPlayer(username) {
                if(!this.players.includes(username)) {
                    this.players.push(username);
                    {#Game.addPlayersToDOM([username]);#}
                }
            }

            disconnectPlayer(username) {
                if(this.players.includes(username)) {
                    this.players.splice(this.players.indexOf(username), 1);
                    Game.removePlayersFromDOM([username]);
                }
            }

            startGame() {
                if(!this.isGameRunning) {
                    this.isGameRunning = true;
                    // Altering DOM elements accordingly.
                    startGameButton.prop("disabled", true);
                    endGameButton.prop("disabled", false);
                    for(let card of myHand.cards) {
                        if(card != null) {
                            myHandList.append(`<li>Category: ${card.category} Number: ${card.number}`);
                        }
                    }
                    topCardElem.html(`Category: ${this.topCard.category} Number: ${this.topCard.number}`);
                }
            }

            endGame() {
                if(this.isGameRunning) {
                    this.setTopCard(null);
                    this.isGameRunning = false;
                    myHand.emptyHand();

                    // Altering DOM elements accordingly.
                    startGameButton.prop("disabled", false);
                    endGameButton.prop("disabled", true);
                    myHandList.empty();
                    topCardElem.html('');
                }
            }

            canPlay(card) {
                // Method to determine whether player can play card on top of currentGame.topCard.

                // If player is currentPlayer
                if(me !== currentGame.getCurrentPlayer()) {
                    return false;
                }

                let category = card.category, number = card.number;
                let topCategory = this.topCard.category, topNumber = this.topCard.number;

                if(category !== WILD_FOUR) {
                    // If color is same OR number is same OR card is WILD card.
                    return category === this.topColor || number === topNumber || category === WILD;
                }
                else if(category === WILD_FOUR) {
                    // Logic for Wild Four Card
                    for(let handCard of myHand.cards) {
                        if(handCard == null) {
                            continue;
                        }
                        if(handCard.category !== WILD_FOUR) {
                            if(this.canPlay(handCard)) {
                                return false;
                            }
                        }
                    }
                    return true;
                }
            }

            static changeSceneRequest(sceneNumber) {
                if(me === gameRoomAdmin) {
                    let data = {"status": "change_scene", "message": "Game is being started.", "data": {"sceneNumber": sceneNumber}};
                    let response = {"type": "change.scene", "text": data};
                    socket.send(JSON.stringify(response));
                }
            }

            static startGameRequest() {
                if(me === gameRoomAdmin) {
                    let data = {"status": "start_game", "message": "Game is being started.", "data": {}};
                    let response = {"type": "start.game", "text": data};
                    socket.send(JSON.stringify(response));
                }
                else {
                    alert("You are not game Room Admin!");
                }
            }

            static endGameRequest() {
                if(me === gameRoomAdmin) {
                    let data = {"status": "end_game", "message": "Game is being ended.", "data": {}};
                    let response = {"type": "end.game", "text": data};
                    socket.send(JSON.stringify(response));
                }
                else {
                    alert("You are not game Room Admin!");
                }
            }

            playCardRequest(card, index) {
                // Method to send data to backend using socket and play a card.
                // If the move is valid, server will respond.
                if(me === currentGame.getCurrentPlayer()) {
                    if(this.canPlay(card)) {
                        let nextTopColor;
                        if(card.category === WILD_FOUR || card.category === WILD) {
                            nextTopColor = prompt("Choose Next Color ('B', 'Y', 'G' or 'R')");
                        }
                        else {
                            nextTopColor = card.category;
                        }
                        let data = {"status": "play_card", "message": "A player played a card.", "data": {"username": this.getCurrentPlayer(), "card": card, "index": index, "next_top_color": nextTopColor,}};
                        let response = {"type": "play.card", "text": data};
                        socket.send(JSON.stringify(response));
                    }
                    else {
                        alert("You cannot play this card!");
                    }
                }
                else {
                    alert(`Cheating: You = ${me} and Current Player = ${currentGame.getCurrentPlayer()}`);
                }
            }

            drawCardRequest() {
                if(me === currentGame.getCurrentPlayer()) {
                    if(this.canDrawCard) {
                        this.canDrawCard = false;
                        let data = {"status": "voluntary_draw_card", "message": "A player drew a card.", "data": {"username": this.getCurrentPlayer() }};
                        let response = {"type": "voluntary_draw_card", "text": data};
                        socket.send(JSON.stringify(response));
                    }
                    else {
                        alert("You have already drawn a card for this move!");
                    }
                }
                else {
                    alert(`Cheating: You = ${me} and Current Player = ${currentGame.getCurrentPlayer()}`);
                }
            }

            keepCardAfterDrawingRequest(card) {
                if(me === currentGame.getCurrentPlayer()) {
                    let data = {"status": "keep_card", "message": "The player kept the card after drawing.", "data": {"username": this.getCurrentPlayer() }};
                    let response = {"type": "keep.card", "text": data};
                    socket.send(JSON.stringify(response));
                }
                else {
                    alert(`Cheating: You = ${me} and Current Player = ${currentGame.getCurrentPlayer()}`);
                }
            }

            callUnoRequest() {
                if(!currentGame.isGameRunning) { // If game has not started yet.
                    alert("Glad to see your excitement, but let the game begin first!");
                    return;
                }
                if(me === currentGame.getCurrentPlayer()) {
                    let activeCardsCount = parseInt(myHand.getActiveCount());
                    if(activeCardsCount === 2) {
                        alert("Sending Call UNO Request!");
                        let data = {"status": "call_uno", "message": "The player called UNO.", "data": {"username": this.getCurrentPlayer() }};
                        let response = {"type": "call.uno", "text": data};
                        socket.send(JSON.stringify(response));
                    }
                    else if(activeCardsCount === 1) {
                        alert("It's too late to call UNO! Let's hope that someone doesn't point it out.");
                    }
                    else {
                        alert("We understand you are eager to scream UNO, but you also need to be left with only one card to scream UNO!");
                    }
                }
                else {
                    alert(`Cheating: You = ${me} and Current Player = ${currentGame.getCurrentPlayer()}`);
                }
            }

            catchPlayerRequest(oppUsername) { // Called when current player points out that someone has not called UNO.
                if(!currentGame.isGameRunning) { // If game has not started yet.
                    alert("Glad to see your excitement, but let the game begin first!");
                    return;
                }
                if(oppUsername === currentGame.getCurrentPlayer()) { // The person who is being challenged is currrent player.
                    alert(`You are challenging ${oppUsername}`);
                    let data = {"status": "catch_player", "message": "The player is caught.", "data": {"catcher": me, "caught": this.getCurrentPlayer() }};
                    let response = {"type": "catch.player", "text": data};
                    socket.send(JSON.stringify(response));
                }
                else {
                    alert(`${oppUsername} is not current player.`);
                }
            }

            static addPlayersToDOM(players) {
                for (let player of players) {
                    let appendIt = `<li id="id_connected_players_${player}_{{ game_room.pk }}">${player}</li>`;
                    connectedList.append(appendIt);
                }
            }

            static addScoreToDOM(player, score) {
                let editElem = $(`#id_connected_players_${player}_{{ game_room.pk }}`);
                editElem.html(`${player} (${score})`);
            }

            static removePlayersFromDOM(players) {
                for (let player of players) {
                    let removeID = `#id_connected_players_${player}_{{ game_room.pk }}`;
                    $(removeID).remove();
                }
            }
        }
    </script>

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.1/peerjs.min.js"></script>

    <script>
        // Constants
        {#navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;#}
        const ERROR = "error";
        const SUCCESS = "success";
        const STREAM = navigator.mediaDevices.getUserMedia({video: false, audio: true});
        const peers = {};

        // Fetching Endpoint
        let loc = window.location;
        let wsStart = 'ws://';
        if(loc.protocol === 'https:') {
            // To make it Production Ready
            wsStart = 'wss://'
        }
        let endpoint = wsStart + loc.host + loc.pathname;
        // Making WebSocket Object
        // let socket = new ReconnectingWebSocket(endpoint);

        let socket = new WebSocket(endpoint);

        let currentGame = null;
        let myHand = new Hand();
        let me = "{{ user.username }}";
        let gameRoomAdmin = "{{ game_room.admin.username }}";

        const my_peer = new Peer(undefined, { // making available a Peer Object from peerjs library to work on the root path
            host: '/',
            port: '8001'
            // host: 'sangwan-b816cac0.localhost.run',
            // port: ''
        });

        const get_my_peer_id = new Promise(resolve => {
            my_peer.on('open', (uid) => {
                {#console.log("My peer ID is: ", uid);#}
                    resolve({"unique_peer_id": uid});
            });
        });

        const open_socket = new Promise(resolve => {
            socket.addEventListener("open", (e) => {
                resolve({"open_socket_state": socket.readyState});
            });
        });

        Promise.all([get_my_peer_id, open_socket]).then(result => {
             console.log("open");
             {#console.log(result);#}
             MY_UNIQUE_PEER_ID = result[0].unique_peer_id;
             let client_data = {"new_user_username" : "{{ user.username }}", "unique_peer_id": result[0].unique_peer_id, "game_room_unique_id": "{{ game_room.unique_game_id }}"};
             let client_response = {"type": "user.new", "text": client_data};
             {#console.log("Sending: ", client_data);#}
             {#console.log(socket.readyState);#}
             socket.send(JSON.stringify(client_response));

             STREAM.then(stream => {
                addVideoStream(Video, stream, "{{user.username}}");
             });

            // Entering the Game Room (when socket connection opens).
            let data = {"status": "connected", "message": "Connecting...", "data": {"username": "{{ user.username }}", "pk": "{{ user.pk }}",}};
            let response = {"type": "enter.room", "text": data};
            socket.send(JSON.stringify(response));

            // When start game Button is clicked
            {#startGameButton.click(function () {#}
            {#    let data = {"status": "start_game", "message": "Game is being started.", "data": {}};#}
            {#    response = {"type": "start.game", "text": data};#}
            {#    socket.send(JSON.stringify(response));#}
            {# });#}

            // When End Game Button is clicked
            {#endGameButton.click(function () {#}
            {#    let data = {"status": "end_game", "message": "Game is being ended.", "data": {}};#}
            {#    response = {"type": "end.game", "text": data};#}
            {#    socket.send(JSON.stringify(response));#}
            {# });#}
        });

        VideoGrid = document.getElementById('VideoGrid');
        let Video = document.createElement('video'); // This video Element will contain users own video

        function addVideoStream(Video, stream, label="Some user in Room") {
            {#console.log("Used to Add own stream on open and then for the other users.");#}
            Video.srcObject = stream; // adding the stream as the src of the video to our myVideo video Element
            Video.addEventListener('loadedmetadata', () => {
                Video.play()
            });
            {#console.log("Video is Playing...");#}
            let NewVideoCont = document.createElement('div');
            NewVideoCont.style.display = "inline-block";
            NewVideoCont.style.boxSizing = "border-box";
            NewVideoCont.style.width = "100px";
            let NewVideoLabel = document.createElement('p');
            NewVideoLabel.innerHTML = label;
            VideoGrid.append(NewVideoCont);
            NewVideoCont.append(NewVideoLabel);
            NewVideoCont.id = "div_" + label;
            NewVideoLabel.id = label;
            Video.id = "vid_" + label;
            NewVideoCont.append(Video);
            {#console.log(label, " is the label");#}
            if(label === "{{ user.username }}"){
                Video.muted = true;
            }
        }

        function connectToNewUser(other_unique_peer_id, var_new_user_username){
            if(MY_UNIQUE_PEER_ID === other_unique_peer_id){
                {#console.log("No Need to Call Yourself...");#}
                return ;
            }
            {#console.log("Called Connect to new user");#}
            STREAM.then(stream => {
                {#console.log("Calling... Peer", var_new_user_username, "at id:", other_unique_peer_id);#}
                setTimeout(()=>{
                    const call = my_peer.call(other_unique_peer_id, stream, {metadata: {"username": "{{user.username}}"}}); // Calling the Newly Connected peer
                    {#console.log("Called Peer");#}
                    const Video = document.createElement('video');
                    {#console.log("video Element Created.");#}
                    call.on('stream', remoteStream => { // adding the others video element to video-grid on our page.
                        {#console.log("tung");#}
                        {#console.log(peers[var_new_user_username]);#}
                        if(peers[var_new_user_username] !== undefined){
                            {#console.log("Second Call");#}
                        }
                        else{
                            {#console.log("First Call");#}
                            {#console.log("Receiving the Answer");#}
                            addVideoStream(Video, remoteStream, var_new_user_username);
                            {#console.log("Steam of guy whom i called:",var_new_user_username, "is Added");#}
                            peers[var_new_user_username] = call;
                        }
                    });
                    call.on('close', () => {
                        Video.remove();
                        {#console.log("Removed from close");#}
                    });
                }, 2000);
            });
        }

        STREAM.then((stream) => {
            my_peer.on('call', (call) => { // Someone is Calling me
                var caller = call.metadata.username;
                {#console.log("Someone Just Called Me.", caller);#}
                {#console.log("Answering the Call...");#}

                call.answer(stream); // Answer the call with an A/V stream.
                {#console.log("Answered the Call...");#}
                const othersVideo = document.createElement('video');
                call.on('stream', (remoteStream) => {
                     if(peers[caller] !== undefined){ // Already Answered Once
                        {#console.log("Second Answer");#}
                     }
                     else{
                         {#console.log("First Answer");#}
                         peers[caller] = call;
                         {#console.log("For user who just Called me adding his Stream.");#}
                         addVideoStream(othersVideo, remoteStream, caller);
                     }
                 });
            });
        });

        socket.addEventListener("message", function (e) {
            {# console.log("message");#}
            console.log("Message from enter_game_room.");
            let backendResponse = JSON.parse(e.data);
            let status = backendResponse.status;
            let message = backendResponse.message;
            let data = backendResponse.data;
            let gameData;
            let left_user_username = backendResponse.left_user_username;
            if(left_user_username){
                {#console.log(left_user_username, "Disconnect Ho gya...");#}
                if (peers[left_user_username]){
                    {#console.log("Aur tha bhi");#}
                    peers[left_user_username].close();
                    delete peers[left_user_username];
                     if(document.getElementById("div_" + left_user_username)){
                        document.getElementById("div_" + left_user_username).remove();
                     }
                     if(document.getElementById("vid_" + left_user_username)){
                        document.getElementById("vid_" + left_user_username).remove();
                     }
                }
                else{
                    {#console.log("Tha hi nhi");#}
                }
                if(document.getElementById(left_user_username)){
                    document.getElementById(left_user_username).remove();
                }
            }
            else if(backendResponse.unique_peer_id && backendResponse.game_room_unique_id){
                let var_game_room_unique_id = backendResponse.game_room_unique_id;
                let var_unique_peer_id = backendResponse.unique_peer_id;
                let var_new_user_username = backendResponse.new_user_username;
                {#console.log("Mai hu {{ user }} abhi peer_id_mili hai server se: " + backendResponse.unique_peer_id + ", " +  backendResponse.game_room_unique_id + ", is bnde ko call karunga...");#}
                connectToNewUser(var_unique_peer_id, var_new_user_username);
            }

            if(backendResponse.gameData) {
                gameData = JSON.parse(backendResponse.gameData);
                console.log(gameData);
                if(currentGame == null) {
                    currentGame = new Game(gameData);
                }
             }

            let username, pk, elementToAppend;

            if(status === "connected") {
                console.log("From enter_game_room, connected: ", data.username);
                username = data.username;
                currentGame.connectPlayer(username);
            }
            else if(status === "disconnected") {
                {#username = data.username;#}
                {#currentGame.disconnectPlayer(username);#}
            }
            else if(status === "broadcast_notification") {
                elementToAppend = `<li>${message}</li>`;
                notificationList.append(elementToAppend);
            }
            else if(status === "start_game") {
                // This is handled in Scene2.js's create() method.
            }
            else if(status === "end_game") {
                // This is handled in Scene2.js's create() method.
            }
            else if(status === "play_card") {
                // This is handled in Scene2.js's create() method.
            }
            else if(status === "draw_card") {
                // This is handled in Scene2.js's create() method.
            }

        });

        socket.onerror = function (e) {
            console.log("error");
        };

        socket.onclose = function (e) {
            console.log("close");
        };

    </script>
{% endblock %}

{#{% extends 'base.html' %}#}
{#{% load static %}#}
{#{% comment %}#}
{#    context = {#}
{#        'game_room': game_room,#}
{#        'players': players_qs,#}
{#    }#}
{#{% endcomment %}#}
{#{% block title %} Game Room Detail {% endblock %}#}
{##}
{#{% block styles %}#}
{#    <style type="text/css">#}
{#    canvas {#}
{#		    display: block;#}
{#		    margin: 0;#}
{#		    position: absolute;#}
{#		    top: 50%;#}
{#		    left: 70%;#}
{#		    transform: translate(-50%, -50%);#}
{#		}#}
{#    #VideoGrid{#}
{#        border: red dotted 2px;#}
{#        width: 40%;#}
        {#display: grid;#}
{#        grid-template-columns: repeat(auto-fill, 300px);#}
{#        grid-auto-rows: 300px;#}
{#    }#}
{#    video{#}
        {#display: inline-block;#}
{#        width: 100%;#}
{#        height: 100%;#}
{#        object-fit: cover;#}
{#    }#}
{##}
{#    </style>#}
{#{% endblock %}#}
{##}
{#{% block content %}#}
{#    {% if game_room %}#}
{#        <div>#}
{#            Game Room ID: {{ game_room.unique_game_id }}#}
{#            <br/>#}
{#            Game Room Admin: {{ game_room.admin.username }}#}
{#            <br/>#}
{#            <br/>#}
{#            {% if user.is_authenticated and user.username == game_room.admin.username %}#}
{#                <button id="id_start_game_{{ game_room.pk }}">#}
{#                    Start Game#}
{#                </button>#}
{#                <br/>#}
{#                <button id="id_end_game_{{ game_room.pk }}" disabled>#}
{#                    End Game#}
{#                </button>#}
{#            {% endif %}#}
{#            <br/>#}
{#            <br/>#}
{#        </div>#}
{#        <div>#}
{#            <div style="display: inline-block; border-style: dotted; margin-right: 50px;">#}
{#                <p>Connected Players</p>#}
{#                <ul id="id_connected_players_{{ game_room.pk }}">#}
{#                    {% for player in players %}#}
{#                        {% if player.is_online %}#}
{#                            <li id="id_connected_players_{{ player.player.pk }}_{{ game_room.pk }}">{{ player.player.username }}</li>#}
{#                        {% endif %}#}
{#                    {% endfor %}#}
{#                </ul>#}
{#            </div>#}
{#            <div style="display: inline-block; border-style: dotted;">#}
{#                <p>Game Room Notifications</p>#}
{#                <ul id="id_game_room_notifications_{{ game_room.pk }}">#}
{##}
{#                </ul>#}
{#            </div>#}
{#            <br/>#}
{#            <div style="display: inline-block; margin-right: 50px; border-style: dotted;">#}
{#                <p>Current Top Card</p>#}
{#                <p id="id_top_card_{{ game_room.unique_game_id }}"></p>#}
{#            </div>#}
{#            <div style="display: inline-block; border-style: dotted; margin-top: 35px;">#}
{#                <p>My Hand</p>#}
{#                <ul id="id_hand_{{ user.username }}_{{ game_room.unique_game_id }}">#}
{#                </ul>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <div id="VideoGrid">#}
{#            <video >#}
{#                <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">#}
{#                Your browser does not support HTML video.#}
{#            </video>#}
{#        </div>#}
{##}
{##}
{#    {% endif %}#}
{#{% endblock %}#}
{##}
{#{% block javascript %}#}
{#    <script type="text/javascript" src="{% static 'js/phaserjs/game.js' %}"></script>#}
{#    <script type="text/javascript" src="{% static 'js/phaserjs/Scene1.js' %}"></script>#}
{#    <script type="text/javascript" src="{% static 'js/phaserjs/Scene2.js' %}"></script>#}
{##}
{#    <script>#}
{#        // This script tag contains only DOM elements picked using jQuery.#}
{#        let connectedList = $("#id_connected_players_{{ game_room.pk }}");#}
{#        let connectedListChildren = connectedList.children();#}
{#        let startGameButton = $('#id_start_game_{{ game_room.pk }}');#}
{#        let endGameButton = $('#id_end_game_{{ game_room.pk }}');#}
{#        let notificationList = $('#id_game_room_notifications_{{ game_room.pk }}');#}
{#        let myHandList = $("#id_hand_{{ user.username }}_{{ game_room.unique_game_id }}");#}
{#        let topCardElem = $("#id_top_card_{{ game_room.unique_game_id }}");#}
{#    </script>#}
{##}
{#    <script>#}
{##}
{#        /*#}
{#            This script tag contains only classes defined in this file.#}
{#            Following classes have been defined so far:#}
{#            1. Card#}
{#            2. Hand#}
{#            3. Game#}
{#        */#}
{##}
{#        class Card {#}
{#            constructor(category, number) {#}
{#                this.category = category;#}
{#                this.number = number;#}
{#            }#}
{#        }#}
{##}
{#        class Hand {#}
{#            constructor() {#}
{#                this.cards = [];#}
{#                this.cardSprites = []; // Sprites corresponding to cards#}
{#            }#}
{##}
{#            emptyHand() {#}
{#                this.cardSprites = [];#}
{#                this.cards = [];#}
{#            }#}
{##}
{#            getCount() {#}
{#                // Method that returns count of cards in this hand.#}
{#                return this.cards.length;#}
{#            }#}
{##}
{#            getActiveCount() {#}
{#                // Returns count of active card i.e. not null cards only.#}
{#                let count = 0;#}
{#                for(let card of this.cards) {#}
{#                    if(card != null) {#}
{#                        count++;#}
{#                    }#}
{#                }#}
{#                return count;#}
{#            }#}
{##}
{#            getCardAt(i) {#}
{#                // Method to return card at ith index in this hand.#}
{#                if(i < this.getCount()) {#}
{#                    return this.cards[i];#}
{#                }#}
{#            }#}
{##}
{#            getCardSpriteAt(i) {#}
{#                if(i < this.getCount()) {#}
{#                    return this.cardSprites[i];#}
{#                }#}
{#            }#}
{##}
{#            removeCardAndCardSpriteAt(i) {#}
                {#this.cards.splice(i, 1);#}
                {#this.cardSprites.splice(i, 1);#}
{#                this.cards[i] = null;#}
{#                this.cardSprites[i] = null;#}
{#            }#}
{##}
{#            addCardAndCardSprite(card, cardSprite) {#}
{#                this.cards.push(card);#}
{#                this.cardSprites.push(cardSprite);#}
{#            }#}
{##}
{#            getDepth(cardSprite) {#}
{#                // Getting depth of the card.#}
{#                let depth = 1;#}
{#                for(let i = 0; i < this.getCount(); ++i) {#}
{#                    let thisCardSprite = this.getCardSpriteAt(i);#}
{#                    if(thisCardSprite != null) {#}
{#                        if(JSON.stringify(cardSprite) === JSON.stringify(thisCardSprite)) {#}
{#                            return depth;#}
{#                        }#}
{#                        depth += 1;#}
{#                    }#}
{#                }#}
{#            }#}
{#        }#}
{##}
{#        class Game {#}
{#            constructor(gameData) {#}
                {#console.log(gameData);#}
{#                this.uniqueId = gameData.uniqueId;#}
{#                this.players = gameData.players;#}
{#                this.topCard = gameData.topCard;#}
{#                this.topColor = gameData.topColor;#}
{#                this.direction = gameData.direction;#}
{#                this.currentPlayerIndex = gameData.currentPlayerIndex;#}
{#                this.isGameRunning = false;#}
{#                this.canDrawCard = false;#}
{#                this.coordinatesOfPlayers = {};#}
{#                // Adding Players to DOM.#}
{#                Game.addPlayersToDOM(this.players);#}
{#            }#}
{##}
{#            copyData(gameData) {#}
                {#console.log(gameData);#}
{#                if(gameData.topCard) {#}
{#                    this.topCard = new Card(gameData.topCard.category, gameData.topCard.number);#}
{#                    this.topColor = gameData.topColor;#}
{#                }#}
{#                this.direction = gameData.direction;#}
{#                this.currentPlayerIndex = gameData.currentPlayerIndex;#}
{#            }#}
{##}
{#            getTopCard() {#}
{#                return this.topCard;#}
{#            }#}
{##}
{#            getPlayersCount() {#}
{#                return this.players.length;#}
{#            }#}
{##}
{#            getPlayers() {#}
{#                return this.players;#}
{#            }#}
{##}
{#            getCurrentPlayer() {#}
{#                if(this.currentPlayerIndex >= 0) {#}
{#                    return this.players[this.currentPlayerIndex];#}
{#                }#}
{#                else {#}
{#                    return null;#}
{#                }#}
{#            }#}
{##}
{#            setTopCard(card) {#}
{#                this.topCard = card;#}
{#            }#}
{##}
{#            connectPlayer(username) {#}
{#                if(!this.players.includes(username)) {#}
{#                    this.players.push(username);#}
{#                    Game.addPlayersToDOM([username]);#}
{#                }#}
{#            }#}
{##}
{#            disconnectPlayer(username) {#}
{#                if(this.players.includes(username)) {#}
{#                    this.players.splice(this.players.indexOf(username), 1);#}
{#                    Game.removePlayersFromDOM([username]);#}
{#                }#}
{#            }#}
{##}
{#            startGame() {#}
{#                if(!this.isGameRunning) {#}
{#                    this.isGameRunning = true;#}
{#                    // Altering DOM elements accordingly.#}
{#                    startGameButton.prop("disabled", true);#}
{#                    endGameButton.prop("disabled", false);#}
{#                    for(let card of myHand.cards) {#}
{#                        if(card != null) {#}
{#                            myHandList.append(`<li>Category: ${card.category} Number: ${card.number}`);#}
{#                        }#}
{#                    }#}
{#                    topCardElem.html(`Category: ${this.topCard.category} Number: ${this.topCard.number}`);#}
{#                }#}
{#            }#}
{##}
{#            endGame() {#}
{#                if(this.isGameRunning) {#}
{#                    this.setTopCard(null);#}
{#                    this.isGameRunning = false;#}
{#                    myHand.emptyHand();#}
{##}
{#                    // Altering DOM elements accordingly.#}
{#                    startGameButton.prop("disabled", false);#}
{#                    endGameButton.prop("disabled", true);#}
{#                    myHandList.empty();#}
{#                    topCardElem.html('');#}
{#                }#}
{#            }#}
{##}
{#            canPlay(card) {#}
{#                // Method to determine whether player can play card on top of currentGame.topCard.#}
{##}
{#                // If player is currentPlayer#}
{#                if(me !== currentGame.getCurrentPlayer()) {#}
{#                    return false;#}
{#                }#}
{##}
{#                let category = card.category, number = card.number;#}
{#                let topCategory = this.topCard.category, topNumber = this.topCard.number;#}
{##}
{#                if(category !== WILD_FOUR) {#}
{#                    // If color is same OR number is same OR card is WILD card.#}
{#                    return category === this.topColor || number === topNumber || category === WILD;#}
{#                }#}
{#                else if(category === WILD_FOUR) {#}
{#                    // Logic for Wild Four Card#}
{#                    for(let handCard of myHand.cards) {#}
{#                        if(handCard == null) {#}
{#                            continue;#}
{#                        }#}
{#                        if(handCard.category !== WILD_FOUR) {#}
{#                            if(this.canPlay(handCard)) {#}
{#                                return false;#}
{#                            }#}
{#                        }#}
{#                    }#}
{#                    return true;#}
{#                }#}
{#            }#}
{##}
{#            playCardRequest(card, index) {#}
{#                // Method to send data to backend using socket and play a card.#}
{#                // If the move is valid, server will respond.#}
{#                if(me === currentGame.getCurrentPlayer()) {#}
{#                    if(this.canPlay(card)) {#}
{#                        let nextTopColor;#}
{#                        if(card.category === WILD_FOUR || card.category === WILD) {#}
{#                            nextTopColor = prompt("Choose Next Color ('B', 'Y', 'G' or 'R')");#}
{#                        }#}
{#                        else {#}
{#                            nextTopColor = card.category;#}
{#                        }#}
{#                        let data = {"status": "play_card", "message": "A player played a card.", "data": {"username": this.getCurrentPlayer(), "card": card, "index": index, "next_top_color": nextTopColor,}};#}
{#                        let response = {"type": "play.card", "text": data};#}
{#                        socket.send(JSON.stringify(response));#}
{#                    }#}
{#                    else {#}
{#                        alert("You cannot play this card!");#}
{#                    }#}
{#                }#}
{#                else {#}
{#                    alert(`Cheating: You = ${me} and Current Player = ${currentGame.getCurrentPlayer()}`);#}
{#                }#}
{#            }#}
{##}
{#            drawCardRequest() {#}
{#                if(me === currentGame.getCurrentPlayer()) {#}
{#                    if(this.canDrawCard) {#}
{#                        this.canDrawCard = false;#}
{#                        let data = {"status": "voluntary_draw_card", "message": "A player drew a card.", "data": {"username": this.getCurrentPlayer() }};#}
{#                        let response = {"type": "voluntary_draw_card", "text": data};#}
{#                        socket.send(JSON.stringify(response));#}
{#                    }#}
{#                    else {#}
{#                        alert("You have already drawn a card for this move!");#}
{#                    }#}
{#                }#}
{#                else {#}
{#                    alert(`Cheating: You = ${me} and Current Player = ${currentGame.getCurrentPlayer()}`);#}
{#                }#}
{#            }#}
{##}
{#            keepCardAfterDrawingRequest() {#}
{#                if(me === currentGame.getCurrentPlayer()) {#}
{#                    let data = {"status": "keep_card", "message": "The player kept the card after drawing.", "data": {"username": this.getCurrentPlayer() }};#}
{#                    let response = {"type": "keep.card", "text": data};#}
{#                    socket.send(JSON.stringify(response));#}
{#                }#}
{#                else {#}
{#                    alert(`Cheating: You = ${me} and Current Player = ${currentGame.getCurrentPlayer()}`);#}
{#                }#}
{#            }#}
{##}
{#            static addPlayersToDOM(players) {#}
{#                for (let player of players) {#}
{#                    let appendIt = `<li id="id_connected_players_${player}_{{ game_room.pk }}">${player}</li>`;#}
{#                    connectedList.append(appendIt);#}
{#                }#}
{#            }#}
{##}
{#            static addScoreToDOM(player, score) {#}
{#                let editElem = $(`#id_connected_players_${player}_{{ game_room.pk }}`);#}
{#                editElem.html(`${player} (${score})`);#}
{#            }#}
{##}
{#            static removePlayersFromDOM(players) {#}
{#                for (let player of players) {#}
{#                    let removeID = `#id_connected_players_${player}_{{ game_room.pk }}`;#}
{#                    $(removeID).remove();#}
{#                }#}
{#            }#}
{#        }#}
{#    </script>#}
{##}
{#    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>#}
{#    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.1/peerjs.min.js"></script>#}
{##}
{#    <script>#}
{#        // Constants#}
        {#navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;#}
{#        const ERROR = "error";#}
{#        const SUCCESS = "success";#}
{#        const STREAM = navigator.mediaDevices.getUserMedia({video: false, audio: true});#}
{#        const peers = {};#}
{##}
{#        // Fetching Endpoint#}
{#        let loc = window.location;#}
{#        let wsStart = 'ws://';#}
{#        if(loc.protocol === 'https:') {#}
{#            // To make it Production Ready#}
{#            wsStart = 'wss://'#}
{#        }#}
{#        let endpoint = wsStart + loc.host + loc.pathname;#}
{#        // Making WebSocket Object#}
{#        // let socket = new ReconnectingWebSocket(endpoint);#}
{##}
{#        let socket = new WebSocket(endpoint);#}
{##}
{#        let currentGame = null;#}
{#        let myHand = new Hand();#}
{#        let me = "{{ user.username }}";#}
{##}
{#        const my_peer = new Peer(undefined, { // making available a Peer Object from peerjs library to work on the root path#}
{#            host: '/', //'pirateksh-47c7ba45.localhost.run',#}
{#            port: '8001'#}
{#            // host: 'sangwan-b816cac0.localhost.run',#}
{#            // port: ''#}
{#        });#}
{##}
{#        const get_my_peer_id = new Promise(resolve => {#}
{#            my_peer.on('open', (uid) => {#}
{#                console.log("My peer ID is: ", uid);#}
{#                    resolve({"unique_peer_id": uid});#}
{#            });#}
{#        });#}
{##}
{#        const open_socket = new Promise(resolve => {#}
{#            socket.addEventListener("open", (e) => {#}
{#                resolve({"open_socket_state": socket.readyState});#}
{#            });#}
{#        });#}
{##}
{#        Promise.all([get_my_peer_id, open_socket]).then(result => {#}
{#             console.log("open");#}
             {#console.log(result);#}
{#             MY_UNIQUE_PEER_ID = result[0].unique_peer_id;#}
{#             let client_data = {"new_user_username" : "{{ user.username }}", "unique_peer_id": result[0].unique_peer_id, "game_room_unique_id": "{{ game_room.unique_game_id }}"};#}
{#             let client_response = {"type": "user.new", "text": client_data};#}
{#             console.log("Sending: ", client_data);#}
{#             console.log(socket.readyState);#}
{#             socket.send(JSON.stringify(client_response));#}
{##}
{#             STREAM.then(stream => {#}
{#                addVideoStream(Video, stream, "{{user.username}}");#}
{#             });#}
{##}
{#            // Entering the Game Room (when socket connection opens).#}
{#            let data = {"status": "connected", "message": "Connecting...", "data": {"username": "{{ user.username }}", "pk": "{{ user.pk }}",}};#}
{#            let response = {"type": "enter.room", "text": data};#}
{#            socket.send(JSON.stringify(response));#}
{##}
{#            // When start game Button is clicked#}
{#            startGameButton.click(function () {#}
{#                let data = {"status": "start_game", "message": "Game is being started.", "data": {}};#}
{#                response = {"type": "start.game", "text": data};#}
{#                socket.send(JSON.stringify(response));#}
{#            });#}
{##}
{#            // When End Game Button is clicked#}
{#            endGameButton.click(function () {#}
{#                let data = {"status": "end_game", "message": "Game is being ended.", "data": {}};#}
{#                response = {"type": "end.game", "text": data};#}
{#                socket.send(JSON.stringify(response));#}
{#            });#}
{#        });#}
{##}
{#        VideoGrid = document.getElementById('VideoGrid');#}
{#        let Video = document.createElement('video'); // This video Element will contain users own video#}
{##}
{#        function addVideoStream(Video, stream, label="Some user in Room") {#}
{#            console.log("Used to Add own stream on open and then for the other users.");#}
{#            Video.srcObject = stream; // adding the stream as the src of the video to our myVideo video Element#}
{#            Video.addEventListener('loadedmetadata', () => {#}
{#                Video.play()#}
{#            });#}
{#            console.log("Video is Playing...");#}
{#            let NewVideoCont = document.createElement('div');#}
{#            NewVideoCont.style.display = "inline-block";#}
{#            NewVideoCont.style.boxSizing = "border-box";#}
{#            NewVideoCont.style.width = "100px";#}
{#            let NewVideoLabel = document.createElement('p');#}
{#            NewVideoLabel.innerHTML = label;#}
{#            VideoGrid.append(NewVideoCont);#}
{#            NewVideoCont.append(NewVideoLabel);#}
{#            NewVideoCont.id = "div_" + label;#}
{#            NewVideoLabel.id = label;#}
{#            Video.id = "vid_" + label;#}
{#            NewVideoCont.append(Video);#}
{#            console.log(label, " is the label");#}
{#            if(label === "{{ user.username }}"){#}
{#                Video.muted = true;#}
{#            }#}
{#        }#}
{##}
{#        function connectToNewUser(other_unique_peer_id, var_new_user_username){#}
{#            if(MY_UNIQUE_PEER_ID === other_unique_peer_id){#}
{#                console.log("No Need to Call Yourself...");#}
{#                return ;#}
{#            }#}
{#            console.log("Called Connect to new user");#}
{#            STREAM.then(stream => {#}
{#                console.log("Calling... Peer", var_new_user_username, "at id:", other_unique_peer_id);#}
{#                setTimeout(()=>{#}
{#                    const call = my_peer.call(other_unique_peer_id, stream, {metadata: {"username": "{{user.username}}"}}); // Calling the Newly Connected peer#}
{#                    console.log("Called Peer");#}
{#                    const Video = document.createElement('video');#}
{#                    console.log("video Element Created.");#}
{#                    call.on('stream', remoteStream => { // adding the others video element to video-grid on our page.#}
{#                        console.log("tung");#}
{#                        console.log(peers[var_new_user_username]);#}
{#                        if(peers[var_new_user_username] !== undefined){#}
{#                            console.log("Second Call");#}
{#                        }#}
{#                        else{#}
{#                            console.log("First Call");#}
{#                            console.log("Receiving the Answer");#}
{#                            addVideoStream(Video, remoteStream, var_new_user_username);#}
{#                            console.log("Steam of guy whom i called:",var_new_user_username, "is Added");#}
{#                            peers[var_new_user_username] = call;#}
{#                        }#}
{#                    });#}
{#                    call.on('close', () => {#}
{#                        Video.remove();#}
{#                        console.log("Removed from close");#}
{#                    });#}
{#                }, 2000);#}
{#            });#}
{#        }#}
{##}
{#        STREAM.then((stream) => {#}
{#            my_peer.on('call', (call) => { // Someone is Calling me#}
{#                var caller = call.metadata.username;#}
{#                console.log("Someone Just Called Me.", caller);#}
{#                console.log("Answering the Call...");#}
{##}
{#                call.answer(stream); // Answer the call with an A/V stream.#}
{#                console.log("Answered the Call...");#}
{#                const othersVideo = document.createElement('video');#}
{#                call.on('stream', (remoteStream) => {#}
{#                     if(peers[caller] !== undefined){ // Already Answered Once#}
{#                        console.log("Second Answer");#}
{#                     }#}
{#                     else{#}
{#                         console.log("First Answer");#}
{#                         peers[caller] = call;#}
{#                         console.log("For user who just Called me adding his Stream.");#}
{#                         addVideoStream(othersVideo, remoteStream, caller);#}
{#                     }#}
{#                 });#}
{#            });#}
{#        });#}
{##}
{#        socket.addEventListener("message", function (e) {#}
            {# console.log("message");#}
{#            let backendResponse = JSON.parse(e.data);#}
{#            let status = backendResponse.status;#}
{#            let message = backendResponse.message;#}
{#            let data = backendResponse.data;#}
{#            let gameData;#}
{#            let left_user_username = backendResponse.left_user_username;#}
{#            if(left_user_username){#}
{#                console.log(left_user_username, "Disconnect Ho gya...");#}
{#                if (peers[left_user_username]){#}
{#                    console.log("Aur tha bhi");#}
{#                    peers[left_user_username].close();#}
{#                    delete peers[left_user_username];#}
{#                     if(document.getElementById("div_" + left_user_username)){#}
{#                        document.getElementById("div_" + left_user_username).remove();#}
{#                     }#}
{#                     if(document.getElementById("vid_" + left_user_username)){#}
{#                        document.getElementById("vid_" + left_user_username).remove();#}
{#                     }#}
{#                }#}
{#                else{#}
{#                    console.log("Tha hi nhi");#}
{#                }#}
{#                if(document.getElementById(left_user_username)){#}
{#                    document.getElementById(left_user_username).remove();#}
{#                }#}
{#            }#}
{#            else if(backendResponse.unique_peer_id && backendResponse.game_room_unique_id){#}
{#                let var_game_room_unique_id = backendResponse.game_room_unique_id;#}
{#                let var_unique_peer_id = backendResponse.unique_peer_id;#}
{#                let var_new_user_username = backendResponse.new_user_username;#}
                {#console.log("Mai hu {{ user }} abhi peer_id_mili hai server se: " + backendResponse.unique_peer_id + ", " +  backendResponse.game_room_unique_id + ", is bnde ko call karunga...");#}
{#                connectToNewUser(var_unique_peer_id, var_new_user_username);#}
{#            }#}
{##}
{#            if(backendResponse.gameData) {#}
{#                gameData = JSON.parse(backendResponse.gameData);#}
                {#console.log(gameData);#}
{#                if(currentGame == null) {#}
{#                    currentGame = new Game(gameData);#}
{#                }#}
{#            }#}
{##}
{#            let username, pk, elementToAppend;#}
{##}
{#            if(status === "connected") {#}
{#                username = data.username;#}
{#                currentGame.connectPlayer(username);#}
{#            }#}
{#            else if(status === "disconnected") {#}
{#                username = data.username;#}
{#                currentGame.disconnectPlayer(username);#}
{#            }#}
{#            else if(status === "broadcast_notification") {#}
{#                elementToAppend = `<li>${message}</li>`;#}
{#                notificationList.append(elementToAppend);#}
{#            }#}
{#            else if(status === "start_game") {#}
{#                // This is handled in Scene2.js's create() method.#}
{#            }#}
{#            else if(status === "end_game") {#}
{#                // This is handled in Scene2.js's create() method.#}
{#            }#}
{#            else if(status === "play_card") {#}
{#                // This is handled in Scene2.js's create() method.#}
{#            }#}
{#            else if(status === "draw_card") {#}
{#                // This is handled in Scene2.js's create() method.#}
{#            }#}
{##}
{#        });#}
{##}
{#        socket.onerror = function (e) {#}
{#            console.log("error");#}
{#        };#}
{##}
{#        socket.onclose = function (e) {#}
{#            console.log("close");#}
{#        };#}
{##}
{#    </script>#}
{#{% endblock %}#}

<script>
    /*
                let url = "";
                let data = {
                    "status": "broadcast_notification",
                    "message": "Game is being started."
                };
                response = {
                    "type": "broadcast.notification",
                    "text": data
                };
                socket.send(JSON.stringify(response));
                $.ajax({
                    url: url,
                    type: "GET",
                    success: function (json) {
                        console.log(json);
                        let status = json.status;
                        if(status === SUCCESS) {
                            let data = {
                                "status": "broadcast_notification",
                                "message": "Game has been started. Deck is ready. Waiting for hands to be distributed."
                            };
                            response = {
                                "type": "broadcast.notification",
                                "text": data
                            };
                            socket.send(JSON.stringify(response));
                        }
                        else if(status === ERROR) {
                            alert(json.message);
                        }
                    },
                    error: function (xhr) {
                        console.log(xhr);
                    }
                });
                */



     {#let url = "{% url 'end_game' game_room.unique_game_id %}";#}
                {#$.ajax({#}
                {#    url: url,#}
                {#    type: "GET",#}
                {#    success: function (json) {#}
                {#        console.log(json);#}
                {#        let status = json.status;#}
                {#        if(status === SUCCESS) {#}
                {#            let data = {#}
                {#                "status": "broadcast_notification",#}
                {#                "message": "Current Game has ended. You can either leave the room or wait for another game to start."#}
                {#                "data": {}#}
                {#            };#}
                {#            response = {#}
                {#                "type": "broadcast.notification",#}
                {#                "text": data#}
                {#            };#}
                {#            socket.send(JSON.stringify(response));#}
                {#        }#}
                {#        else if(status === ERROR) {#}
                {#            alert(json.message);#}
                {#        }#}
                {#    },#}
                {#    error: function (xhr) {#}
                {#        console.log(xhr);#}
                {#    }#}
                {# });#}
</script>
