{% extends 'base.html' %}
{% load static %}
{% comment %}
    context = {
        'game_room': game_room,
        'players': players_qs,
    }
{% endcomment %}
{% block title %} Game Room Detail {% endblock %}

{% block styles %}
    <style type="text/css">
    canvas {
		    display: block;
		    margin: 0;
		    position: absolute;
		    top: 50%;
		    left: 70%;
		    transform: translate(-50%, -50%);
		}
    </style>
{% endblock %}

{% block content %}
    {% if game_room %}
        <div>
            Game Room ID: {{ game_room.unique_game_id }}
            <br/>
            Game Room Admin: {{ game_room.admin.username }}
            <br/>
            <br/>
            {% if user.is_authenticated and user.username == game_room.admin.username %}
                <button id="id_start_game_{{ game_room.pk }}">
                    Start Game
                </button>
                <br/>
                <button id="id_end_game_{{ game_room.pk }}">
                    End Game
                </button>
            {% endif %}
            <br/>
            <br/>
        </div>
        <div>
            <div style="display: inline-block; border-style: dotted; margin-right: 50px;">
                <p>Connected Players</p>
                <ul id="id_connected_players_{{ game_room.pk }}">
                    {% for player in players %}
                        {% if player.is_online %}
                            <li id="id_connected_players_{{ player.player.pk }}_{{ game_room.pk }}">{{ player.player.username }}</li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
            <div style="display: inline-block; border-style: dotted;">
                <p>Game Room Notifications</p>
                <ul id="id_game_room_notifications_{{ game_room.pk }}">

                </ul>
            </div>
            <br/>
            <div style="display: inline-block; margin-right: 50px; border-style: dotted;">
                <p>Current Top Card</p>
                <p id="id_top_card_{{ game_room.unique_game_id }}"></p>
            </div>
            <div style="display: inline-block; border-style: dotted; margin-top: 35px;">
                <p>My Hand</p>
                <ul id="id_hand_{{ user.username }}_{{ game_room.unique_game_id }}">
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block javascript %}
    <script type="text/javascript" src="{% static 'js/phaserjs/game.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/phaserjs/Scene1.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/phaserjs/Scene2.js' %}"></script>
    <script>
        // Constants
        const ERROR = "error";
        const SUCCESS = "success";

        // Fetching Endpoint
        var loc = window.location;
        var wsStart = 'ws://';
        if(loc.protocol === 'https:') {
            // To make it Production Ready
            wsStart = 'wss://'
        }
        var endpoint = wsStart + loc.host + loc.pathname;

        // Making WebSocket Object
        // var socket = new ReconnectingWebSocket(endpoint);
        var socket = new WebSocket(endpoint);


        var connectedList = $("#id_connected_players_{{ game_room.pk }}");
        var connectedListChildren = connectedList.children();
        var isConnected = [];
        for(var i = 0; i < connectedListChildren.length; ++i) {
            if(!isConnected.includes(connectedListChildren[i].innerText)) {
                isConnected.push(connectedListChildren[i].innerText);
            }
        }

        var startGameButton = $('#id_start_game_{{ game_room.pk }}');
        var endGameButton = $('#id_end_game_{{ game_room.pk }}');

        var notificationList = $('#id_game_room_notifications_{{ game_room.pk }}');

        var myHand = [];
        var topCard;
        var myHandList = $("#id_hand_{{ user.username }}_{{ game_room.unique_game_id }}");
        var topCardElem = $("#id_top_card_{{ game_room.unique_game_id }}");

        socket.onopen = function (e) {
            console.log("open", e);
            // Entering the Game Room (when socket connection opens).
            var data = {
                "status": "connected",
                "message": "Connecting...",
                "data": {
                    "username": "{{ user.username }}",
                    "pk": "{{ user.pk }}",
                }
            };

            var response = {
                "type": "enter.room",
                "text": data
            };
            socket.send(JSON.stringify(response));
            
            // When start game Button is clicked
            startGameButton.click(function () {
                var data = {
                    "status": "broadcast_notification",
                    "message": "Game is being started.",
                    "data": {}
                };
                response = {
                    "type": "broadcast.notification",
                    "text": data
                };
                socket.send(JSON.stringify(response));

                var data = {
                    "status": "start_game",
                    "message": "Game is being started.",
                    "data": {}
                };
                response = {
                    "type": "start.game",
                    "text": data
                };
                socket.send(JSON.stringify(response));


            });

            // When End Game Button is clicked
            endGameButton.click(function () {
                var data = {
                    "status": "broadcast_notification",
                    "message": "Game is being ended.",
                    "data": {}
                };
                response = {
                    "type": "broadcast.notification",
                    "text": data
                };
                socket.send(JSON.stringify(response));

                var data = {
                    "status": "end_game",
                    "message": "Game is being ended.",
                    "data": {}
                };
                response = {
                    "type": "end.game",
                    "text": data
                };
                socket.send(JSON.stringify(response));

            });
        };

        socket.addEventListener("message", function (e) {

        {# });#}
        {#socket.onmessage = function (e) {#}
            console.log("message from enter_game_room", e);
            var backendResponse = JSON.parse(e.data);
            var status = backendResponse.status;
            var message = backendResponse.message;
            var data = backendResponse.data;
            var username, pk, elementToAppend;
            {#if(backendResponse.serializedGame) {#}
            {#    console.log(JSON.parse(backendResponse.serializedGame));#}
            {# }#}
            {#if(backendResponse.serializedPlayer) {#}
            {#    console.log(JSON.parse(backendResponse.serializedPlayer));#}
            {# }#}


            if(status === "connected") {
                username = data.username;
                pk = data.pk;
                if(!isConnected.includes(username)) {
                    isConnected.push(username);
                    var appendIt = `<li id="id_connected_players_${pk}_{{ game_room.pk }}">${username}</li>`;
                    connectedList.append(appendIt);
                }
            }
            else if(status === "disconnected") {
                username = data.username;
                pk = data.pk;
                if(isConnected.includes(username)) {
                    isConnected.splice(isConnected.indexOf(username), 1);
                    var elemId = `#id_connected_players_${pk}_{{ game_room.pk }}`;
                    var elem = $(elemId);
                    elem.remove();
                }
            }
            else if(status === "broadcast_notification") {
                elementToAppend = `<li>${message}</li>`;
                notificationList.append(elementToAppend);
            }
            else if(status === "start_game") {
                myHand = JSON.parse(backendResponse.serializedPlayer).hand;
                topCard = JSON.parse(backendResponse.topCard);
                {#console.log(myHand);#}
                for(let card of myHand) {
                    {#console.log(card);#}
                    myHandList.append(`<li>Category: ${card.category} Number: ${card.number}`);
                }

                topCardElem.html(`Category: ${topCard.category} Number: ${topCard.number}`);
            }
            else if(status === "end_game") {
                myHandList.empty();
                topCardElem.html('');
            }
        }); // CHaNGE

        socket.onerror = function (e) {
            console.log("error", e);
        };

        socket.onclose = function (e) {
            console.log("close", e);
        };
    </script>
{% endblock %}











<script>
    /*
                var url = "";
                var data = {
                    "status": "broadcast_notification",
                    "message": "Game is being started."
                };
                response = {
                    "type": "broadcast.notification",
                    "text": data
                };
                socket.send(JSON.stringify(response));
                $.ajax({
                    url: url,
                    type: "GET",
                    success: function (json) {
                        console.log(json);
                        var status = json.status;
                        if(status === SUCCESS) {
                            var data = {
                                "status": "broadcast_notification",
                                "message": "Game has been started. Deck is ready. Waiting for hands to be distributed."
                            };
                            response = {
                                "type": "broadcast.notification",
                                "text": data
                            };
                            socket.send(JSON.stringify(response));
                        }
                        else if(status === ERROR) {
                            alert(json.message);
                        }
                    },
                    error: function (xhr) {
                        console.log(xhr);
                    }
                });
                */



     {#var url = "{% url 'end_game' game_room.unique_game_id %}";#}
                {#$.ajax({#}
                {#    url: url,#}
                {#    type: "GET",#}
                {#    success: function (json) {#}
                {#        console.log(json);#}
                {#        var status = json.status;#}
                {#        if(status === SUCCESS) {#}
                {#            var data = {#}
                {#                "status": "broadcast_notification",#}
                {#                "message": "Current Game has ended. You can either leave the room or wait for another game to start."#}
                {#                "data": {}#}
                {#            };#}
                {#            response = {#}
                {#                "type": "broadcast.notification",#}
                {#                "text": data#}
                {#            };#}
                {#            socket.send(JSON.stringify(response));#}
                {#        }#}
                {#        else if(status === ERROR) {#}
                {#            alert(json.message);#}
                {#        }#}
                {#    },#}
                {#    error: function (xhr) {#}
                {#        console.log(xhr);#}
                {#    }#}
                {# });#}
</script>
